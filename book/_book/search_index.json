[["id_02-00-00-inference-with-rstan.html", "2 RStanを使った推論", " 2 RStanを使った推論 1章では事前分布の設定，事後分布の導出からサンプル生成までを実装した上でおこなっていだが， 複雑なモデリングの場合は実装が難しい場合もある． ここからはベイズ推論のためのフレームワークStanをRから呼び出せるRStanを利用した推論を行なっていく． あらかじめ公式ドキュメントを参考に必要に応じてRstanをインストールしておくこと． "],["id_02-02-00-review-score.html", "2.1 真のレビュースコア", " 2.1 真のレビュースコア レビューのスコアについてベイス推定を行う．ここでは次のTable 2.1 のデータが得られているとして進めていく． review_score &lt;- tibble( item = rep(c(&#39;A&#39;, &#39;B&#39;), each = 5), score = base::rep(1:5, times = 2), count = c(20, 10, 36, 91, 170, 0, 0, 4, 0, 6) ) review_score %&gt;% pivot_wider(names_from = &quot;score&quot;, values_from = &quot;count&quot;) %&gt;% knitr::kable(caption = &quot;仮想のレビュースコアのデータ&quot;, label = &quot;data-review-score&quot;) %&gt;% kableExtra::kable_styling(full_width = FALSE) Table 2.1: 仮想のレビュースコアのデータ item 1 2 3 4 5 A 20 10 36 91 170 B 0 0 4 0 6 これらのレビューについて回答数と平均点を計算するとTable 2.2 のようになる． Table 2.2: レビュースコアのアイテムごとの回答人数と平均 item total_count mean A 327 4.165138 B 10 4.200000 平均点を見るとどちらも同じ位でかつBの方が若干高い．しかし回答数をみるとAの方が信頼できそうに思える． このデータについては複数の値を取るカテゴリデータと見做してモデルを式 (2.1) のように考えよう． \\[\\begin{align} \\begin{aligned} \\boldsymbol\\theta &amp;\\sim \\text{Dirichlet}(\\boldsymbol\\alpha) \\\\ \\boldsymbol r &amp;\\sim \\text{Categorical}(\\boldsymbol\\theta) \\end{aligned} \\tag{2.1} \\end{align}\\] ディリクレ分布は\\(K\\)次元で，要素が\\([0,1]\\)の値を取り，その総和が\\(1\\)となるような確率変数ベクトルが従う確率分布である．ディリクレ分布自体はパラメータとして\\(K\\)次元ベクトル\\(\\boldsymbol \\alpha\\)を取る． 2.1.1 ディリクレ分布による事前分布 ここで事前分布には簡単のため以下の式 (2.2) を採用しよう． \\[\\begin{align} \\begin{aligned} \\boldsymbol\\theta &amp;\\sim \\text{Dirichlet}(\\boldsymbol\\alpha = (1,1,1,1,1)) \\\\ \\boldsymbol r &amp;\\sim \\text{Categorical}(\\boldsymbol\\theta) \\end{aligned} \\tag{2.2} \\end{align}\\] 2.1.2 推論の実行 RStanでこのモデルについてMCMCを行い事後分布を推定する．stanのコードは次のようになる． data { int n; int&lt;lower=1&gt; n_category; int&lt;lower=0&gt; counts[n]; vector&lt;lower=0&gt;[n_category] alpha; } parameters { simplex[n_category] theta; } model { theta ~ dirichlet(alpha); counts ~ multinomial(theta); } このstanコードを実行して結果を得よう． # item A について多項分布・ディリクレ分布によるベイズ推論を行う df %&gt;% dplyr::filter(item == &quot;A&quot;) n_category &lt;- 5 # カテゴリ数 counts &lt;- df$count # レビュースコアのカウント alphas &lt;- c(1,1,1,1,1) # ディリクレ分布のパラメーター review_data &lt;- list( n_category = n_category, counts = counts, alpha = alpha ) # stanの実行 model_path &lt;- &quot;[path to the stan file]&quot; seed = 1234 fit_item_a &lt;- rstan::stan( file = model_path, data = review_data, seed = seed, iter = 4000, chain = 4, control = list( max_treedepth = 15 ) ) 推定結果は 2.3 のようになった． Table 2.3: Item Aのレビューに対するベイズ推論の結果 mean se_mean sd 2.5% 50% 97.5% Rhat 0.063 0 0.013 0.040 0.062 0.093 1.000 0.033 0 0.010 0.017 0.032 0.055 1.000 0.111 0 0.017 0.080 0.111 0.147 1.000 0.277 0 0.024 0.230 0.277 0.326 1.000 0.515 0 0.028 0.460 0.515 0.569 1.001 ms_a &lt;- rstan::extract(fit_item_a) ms_a$theta %&gt;% tidyr::as_tibble(.name_repair = &quot;unique&quot;) %&gt;% magrittr::set_colnames(paste(&quot;theta&quot;, 1:5, sep=&quot;_&quot;)) %&gt;% tidyr::pivot_longer(cols=everything(), names_to = &quot;theta&quot;, values_to = &quot;sample&quot;) %&gt;% ggplot() + geom_density(aes(x = sample), fill = &quot;blue&quot;, alpha = 0.4) + facet_wrap(~theta) Figure 2.1: Item Aにおける多項分布のパラメータの事後分布 いまレビューの平均スコアを式 (2.3) のように定義すると \\[\\begin{align} m = 1 \\theta_1 + 2 \\theta_2 + 3 \\theta_3 + 4 \\theta_4 + 5 \\theta_5 \\tag{2.3} \\end{align}\\] この確率変数に対してMCMCのサンプルを用いて事後分布を求めることができる． posterior_avg &lt;- ms_a$theta %*% 1:5 above4_a &lt;- round(mean(posterior_avg &gt; 4), 3) subtitle &lt;- glue::glue(&quot;proportion of &gt; 4 = {above4_a}&quot;) posterior_avg %&gt;% tidyr::as_tibble() %&gt;% ggplot() + geom_density(aes(x = V1), fill = &quot;blue&quot;, alpha = 0.4) + xlim(0, 5) + ggtitle(label = &quot;Posterior distribution of Average: Item A&quot;, subtitle = subtitle) -&gt; pa_avg ## Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if ## `.name_repair` is omitted as of tibble 2.0.0. ## ℹ Using compatibility `.name_repair`. ## This warning is displayed once every 8 hours. ## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was ## generated. pa_avg Figure 2.2: Item Aの平均レビュースコアの事後分布 この事後分布に対して，例えば平均のスコアが4以上になる割合は0.99と非常に高く，少なくとも4以上であることは信頼できそうである． 2.1.3 Item Bについての推論 全く同様の手続きで，Item Bについても推論を行なってみよう． モデルは同じなので渡すデータだけ変更すれば良い． df &lt;- review_score %&gt;% dplyr::filter(item == &quot;B&quot;) data_item_b &lt;- list( n_category = 5, counts = df$count, alpha = c(1,1,1,1,1) # 事前分布のパラメーター ) fit_item_b &lt;- rstan::stan( file = &quot;book/script/chapter02/stan/review-score-01.stan&quot;, data = data_item_b, seed = 1234, iter = 4000, chain = 4, control = list(max_treedepth = 15) ) Item Aと同様に推論の結果と事後分布を可視化しておく． summary(fit_item_b)$summary %&gt;% as.data.frame() %&gt;% rownames_to_column() %&gt;% as_tibble() %&gt;% dplyr::filter(rowname != &quot;lp__&quot;) %&gt;% select(mean, se_mean, sd, `2.5%`, `50%`, `97.5%`, Rhat) %&gt;% round(3) %&gt;% knitr::kable(caption = &quot;Item Bのレビューに対するベイズ推論の結果&quot;, label = &quot;stan-result-item-b&quot;) Table 2.4: Item Bのレビューに対するベイズ推論の結果 mean se_mean sd 2.5% 50% 97.5% Rhat 0.067 0.001 0.064 0.002 0.048 0.240 1 0.067 0.001 0.063 0.002 0.048 0.238 1 0.334 0.001 0.117 0.133 0.325 0.581 1 0.066 0.001 0.062 0.002 0.048 0.228 1 0.465 0.001 0.123 0.232 0.464 0.705 1 ms_b &lt;- rstan::extract(fit_item_b) ms_b$theta %&gt;% tidyr::as_tibble(.name_repair = &quot;unique&quot;) %&gt;% magrittr::set_colnames(paste(&quot;theta&quot;, 1:5, sep=&quot;_&quot;)) %&gt;% tidyr::pivot_longer(cols=everything(), names_to = &quot;theta&quot;, values_to = &quot;sample&quot;) %&gt;% ggplot() + geom_density(aes(x = sample), fill = &quot;orange&quot;, alpha = 0.4) + facet_wrap(~theta) Figure 2.3: Item Bにおける多項分布のパラメータの事後分布 posterior_avg &lt;- ms_b$theta %*% 1:5 above4_a &lt;- round(mean(posterior_avg &gt; 4), 3) subtitle &lt;- glue::glue(&quot;proportion of &gt; 4 = {above4_a}&quot;) posterior_avg %&gt;% tidyr::as_tibble() %&gt;% ggplot() + geom_density(aes(x = V1), fill = &quot;orange&quot;, alpha = 0.4) + xlim(0, 5) + ggtitle(label = &quot;Posterior distribution of Average: Item B&quot;, subtitle = subtitle) -&gt; pb_avg pb_avg Figure 2.4: Item Bの平均レビュースコアの事後分布 これらを確認すると，Item Bの方はItem Aに比べて事後分布の形状がやや広いことがわかる． これは回答数が少ないため信頼区間が広くとられていると解釈できる． 2.1.4 推定結果の比較 最後にItem AとItem Bについて比較をまとめておこう． Fig ?? は既に示した図を縦に並べたものだが この比較で平均レビュースコアがどの程度信頼できるものかを確認できる． 量的に表す場合，例えば事後分布のサンプルが4以上であるものの割合を計算すれば ある意味で平均のスコアが4以上になる確率を推論することができる． その意味ではItem Aでは事後分布上で4以上となるものは0.987であり少なくとも4以上であるという ことはかなり信頼を持って言えそうだ． 一方Item Bでは0.268でありこの商品の平均レビュースコアが少なくとも4以上であるということの 信頼性は低いと思える． Figure 2.5: 平均レビュースコアの事後分布の比較 次に，Fig @ref(fig:spread_draws-of-items) はthetaの事後分布を比較した図である． Item Aの場合，thetaの事後分布の幅が比較的狭くなっておりレビューにおけるそれぞれのスコアで 評価される確率のブレが少ない一方，Item Bの場合は幅が広くブレが大きいことがわかる． 特に3と5は広く出ており現時点での平均スコアが4.2という値の信頼性が低いと見做せる． (#fig:spread_draws-of-items)thetaの事後分布の比較 最後にTable 2.5 はthetaの事後分布におけるHDIを比較した表である． HDIの値を確認することでも，事後分布がどれほどの幅を持っているのかを見ることができる． Table 2.5: Itemごとのthetaの事後分布における95%HDI theta Item A Item B 1 [0.038 - 0.09] (0.052) [0 - 0.193] (0.193) 2 [0.015 - 0.053] (0.038) [0 - 0.194] (0.194) 3 [0.08 - 0.146] (0.066) [0.118 - 0.557] (0.439) 4 [0.228 - 0.323] (0.095) [0 - 0.191] (0.191) 5 [0.462 - 0.57] (0.108) [0.229 - 0.7] (0.471) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
